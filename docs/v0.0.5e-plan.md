# v0.0.5e Implementation Plan: Markdown Generation & Export

## Overview

This version focuses on the final step of the MVP: enabling the user to signal the end of the PRD generation process and receive the collected information formatted as Markdown.

1.  **End Conversation Trigger:** Implement a mechanism for the user to indicate they are finished (e.g., typing "/done" or similar command) or have the AI recognize completion.
2.  **Data Extraction Prompt:** Add logic (likely via another AI call) to process the final conversation history and extract the key information for each MVP section into a structured format.
3.  **Markdown Formatting:** Format the extracted structured data into a readable Markdown string.
4.  **Frontend Export UI:** Provide the generated Markdown to the frontend and add UI elements (e.g., buttons) for the user to copy or download the content.

## Prerequisites

-   Completion of `v0.0.5d` (Full MVP conversation flow working).
-   Access to the application development environment (Replit).
-   Access to the codebase.
-   OpenAI API Key configured.

## Test Environment

-   Browser: Chrome latest version (or any modern browser).
-   User Accounts: Standard authenticated user access.
-   Browser Developer Tools (Console tab).

## Database Updates

-   None required for this version.

## Component & Configuration Updates

1.  **API Route (`pages/api/agents/prd-generator.ts`):**
    *   **Action:** Modify the handler to detect the end condition and trigger Markdown generation.
    *   **Details:**
        *   **End Trigger:** In the main request handling logic, check if the `newUserMessage.content` matches a specific command (e.g., `newUserMessage.content.trim().toLowerCase() === '/done'`).
        *   **Extraction Logic (If Triggered):**
            *   Retrieve the final conversation history from the `sessionStore`.
            *   **Make a *separate* call to the OpenAI API (Chat Completions).**
            *   **Prompt for Extraction:** Use a new system prompt specifically asking the AI to read the provided conversation history and extract the information for the defined MVP sections (Exec Summary, Problem, Segments, Solution, Metrics, Risks/Assumptions) and format it as a JSON object. Provide the desired JSON structure in the prompt.
            *   Pass the *entire conversation history* as the user message content to this extraction prompt.
            *   **Parse Response:** Attempt to parse the AI's response as JSON. Handle potential parsing errors.
            *   **Error Handling:** If extraction fails or JSON is invalid, return an appropriate error message to the frontend.
        *   **Markdown Formatting (If Extraction Successful):**
            *   Take the parsed JSON object.
            *   Implement a function (`formatJsonToMarkdown`) to convert this JSON into a well-formatted Markdown string (e.g., using headings, bullet points).
            *   **Return Markdown:** Instead of returning `{ reply: ... }`, return a different structure, e.g., `{ markdown: markdownString }`, to signal to the frontend that the process is complete and provide the content.
        *   **Session Reset:** Clear the conversation history for the session in the `sessionStore` after successful Markdown generation.
    *   **Normal Reply:** If the end trigger is *not* detected, proceed with the normal conversational reply logic as implemented in `v0.0.5d`.

2.  **Frontend Page (`pages/agents/prd-generator.tsx`):**
    *   **Action:** Update `handleSendMessage` to handle the Markdown response and add UI elements for export.
    *   **Details:**
        *   **State:** Add new state variable `generatedMarkdown: string | null = null;`.
        *   **Response Handling:** Modify the `fetch` response handling in `handleSendMessage`:
            *   Check if the response JSON contains a `markdown` key.
            *   If `markdown` exists: Set the `generatedMarkdown` state with the value, display a final confirmation message in the chat (e.g., "PRD generated! You can now copy or download it."), and potentially disable further input.
            *   If only `reply` exists: Handle it as a normal conversational turn (add assistant message to `messages` state).
        *   **Export UI:** Conditionally render new elements when `generatedMarkdown` is not null:
            *   A `textarea` displaying the `generatedMarkdown` (read-only).
            *   A "Copy to Clipboard" button (implement copy logic using `navigator.clipboard.writeText`).
            *   A "Download .md File" button (implement download logic, e.g., by creating a temporary link with a data URI).
        *   Ensure the main chat input is disabled or hidden when Markdown is generated.

3.  **Chat UI Component (`components/agents/ChatInterface.tsx`):**
    *   **Action:** Potentially adjust props or rendering if needed based on parent changes.
    *   **Details:** Ensure the component can be disabled or reflects the final state appropriately based on props passed from `prd-generator.tsx` (e.g., disabling input if `generatedMarkdown` is present).

## Success Criteria

1.  The conversational flow works as before until the end trigger command is sent.
2.  Sending the end trigger command (e.g., "/done") results in a final assistant message indicating generation.
3.  The backend successfully makes a second call to OpenAI to extract structured data from the conversation.
4.  The backend correctly formats the extracted data into a Markdown string.
5.  The frontend receives the Markdown string.
6.  A text area appears on the frontend displaying the generated Markdown.
7.  "Copy to Clipboard" and "Download .md File" buttons appear.
8.  The Copy button successfully copies the Markdown content to the clipboard.
9.  The Download button successfully initiates a download of a `.md` file containing the generated Markdown.
10. The chat input is disabled after generation is complete.
11. Error handling works correctly if JSON extraction or Markdown formatting fails.

## Notes on Scope & Approach

*   Introduces a second AI call specifically for structured data extraction.
*   Relies on the AI's ability to follow instructions to extract data into JSON based on conversation history.
*   Implements basic Markdown formatting based on the extracted JSON.
*   Adds frontend UI for displaying and exporting the final output.
*   Clears the session state upon successful generation.

## Manual Testing Steps

### 1. Full Flow with Generation
-   **Test 1.1:** Complete Conversation and Generate Markdown
    -   **Action:** Start a new conversation. Go through all the MVP steps, providing input. Once the assistant has prompted for the last piece of information (Risks/Assumptions) and acknowledged your input, send the end trigger command (e.g., "/done").
    -   **Expected Result:** The chat input should disable. A final message indicating generation should appear. After a brief delay (for the extraction/formatting), a text area with the generated Markdown content and Copy/Download buttons should appear.
    -   **Status:** PASS
-   **Test 1.2:** Verify Markdown Content
    -   **Action:** Review the generated Markdown in the text area.
    -   **Expected Result:** The Markdown should be well-formatted and contain the information provided during the conversation, organized under the correct MVP headings (Overview, Requirements, Risks).
    -   **Status:** PASS

### 2. Export Functionality
-   **Test 2.1:** Copy to Clipboard
    -   **Action:** Click the "Copy to Clipboard" button.
    -   **Expected Result:** A confirmation (e.g., console log, brief UI change) might appear. Pasting the clipboard contents into a text editor should reveal the generated Markdown.
    -   **Status:** PASS
-   **Test 2.2:** Download .md File
    -   **Action:** Click the "Download .md File" button.
    -   **Expected Result:** The browser should initiate a file download for a `.md` file (e.g., `prd_export.md`). Opening the downloaded file should show the generated Markdown content.
    -   **Status:** PASS

### 3. State Reset
-   **Test 3.1:** Start New Conversation After Generation
    -   **Action:** Refresh the `/agents/prd-generator` page after successfully generating Markdown.
    -   **Expected Result:** The page should load with the initial greeting message, ready for a new conversation. The previous Markdown output should be gone. (This confirms the in-memory session was cleared).
    -   **Status:** PASS

### 4. Error Handling
-   **Test 4.1:** Invalid Extraction (Difficult to force)
    -   **Action:** (Conceptual) If the AI fails to return valid JSON during the extraction step.
    -   **Expected Result:** The frontend should display an appropriate error message in the chat instead of the Markdown output area. The input might remain enabled or show an error state.
    -   **Status:** TBD

### 5. Regression Checks
-   **Test 5.1:** Normal Conversation
    -   **Action:** Start a conversation but do *not* send the end trigger command.
    -   **Expected Result:** The conversation proceeds normally without attempting Markdown generation.
    -   **Status:** TBD 