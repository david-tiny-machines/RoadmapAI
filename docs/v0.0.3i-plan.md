# v0.0.3i Implementation Plan: Phase 3 Tidy-up & Polish

## Overview
Address outstanding known issues, bugs, warnings, and inconsistencies remaining after the core feature development of Phase 3. This includes fixing the Capacity Chart data display, resolving console warnings, standardizing error handling, and adding a missing database constraint. The goal is to ensure a cleaner, more stable codebase before proceeding to Phase 4.

*Note: Specific date/timezone issues identified in v0.0.3a for InitiativeForm/CapacityManager are considered resolved by fixes in v0.0.3g and v0.0.3h.*

## Prerequisites
- Access to the application development environment
- Supabase credentials and access to SQL Editor/Migrations
- Chrome browser for testing
- Completion of v0.0.3h

## Test Environment
- Browser: Chrome latest version
- Screen size: Desktop viewport (1920x1080)
- Network: Test under normal conditions

## Database Updates

### Migration Script (Add Initiative Confidence Constraint)
```sql
-- Add CHECK constraint to ensure initiative confidence is between 0 and 100
ALTER TABLE public.initiatives
  ADD CONSTRAINT confidence_range CHECK (confidence >= 0 AND confidence <= 100);

-- Optional: Add comment for clarity in schema viewers
COMMENT ON CONSTRAINT confidence_range ON public.initiatives IS 'Ensures initiative confidence score is within the valid 0-100 range.';
```
*Migration Workflow Note: The current team standard is to apply schema changes like this manually via the Supabase SQL Editor. Supabase CLI migrations are not currently in standard use.*

## Component & Configuration Updates

1.  **Fix Capacity Chart Initiative Display (`pages/capacity/index.tsx`):**
    *   Identify the page component at `pages/capacity/index.tsx`.
    *   Modify this component to fetch the current user's initiatives list from the Supabase `initiatives` table using `useSupabaseClient` (similar to how `InitiativeList` fetches data).
    *   Ensure the fetched `initiatives` array is passed down as a prop to the `<CapacityManager />` component.

2.  **Fix Metrics Page Runtime Error (`components/metrics/MetricInput.tsx`, `types/database.ts`):**
    *   **Issue:** Metrics page throws "TypeError: Cannot convert undefined or null to object" because `METRIC_TYPE_DISPLAY` is undefined.
    *   **Task:** Define a `METRIC_TYPE_DISPLAY` constant in `types/database.ts` mapping `DbMetricType` values to user-friendly display strings (e.g., `conversion: 'Conversion Rate'`).
    *   **Task:** Import `METRIC_TYPE_DISPLAY` into `components/metrics/MetricInput.tsx` and use it to populate the metric type `<select>` dropdown.

3.  **Add Metrics to Navigation (`components/layout/Header.tsx` or similar):**
    *   **Issue:** The Metrics section (`/metrics`) is not accessible via the main application navigation header.
    *   **Task:** Identify the main navigation component (likely within `components/layout/`).
    *   **Task:** Add a navigation link/item labeled "Metrics" that points to the `/metrics` route, consistent with existing navigation items.

4.  **Resolve Multiple GoTrueClient Instances (`pages/_app.tsx`, `contexts/AuthContext.tsx`):**
    *   **Issue:** The "Multiple GoTrueClient instances" warning persists after v0.0.3h, indicating potential inefficiency.
    *   **Task:** Investigate the interaction between `SessionContextProvider` and the custom `AuthProvider`. Determine the cause of multiple client initializations.
    *   **Task:** Refactor based on investigation findings to ensure only one Supabase client instance is initialized and used. Potential approaches:
        *   Remove the custom `AuthProvider` if redundant.
        *   Modify `AuthProvider` to consume the client from `SessionContextProvider`.
    *   Verify the console warning disappears after the fix.

5.  **Standardize Error Handling UI (Various Components):**
    *   **Goal:** Standardize the display of errors resulting from asynchronous data operations (fetch, save, update, delete).
    *   **Task:** Apply the `ErrorDisplay` component pattern (red box with message, used in `CapacityManager`) consistently for these types of errors.
    *   **Target Files:**
        *   `components/initiatives/InitiativeForm.tsx`
        *   `components/initiatives/InitiativeList.tsx` (for delete/fetch errors)
        *   `components/metrics/MetricInput.tsx`
        *   `pages/auth/*` (for login/signup errors)
    *   Ensure errors are clearly displayed and can be dismissed where appropriate.
    *   *Note: This task focuses on async operation errors; it does not require replacing existing confirmation flows (e.g., modal dialogs for deletion confirmation).*

6.  **Fix MetricInput NaN Warning (`components/metrics/MetricInput.tsx`):**
    *   Locate the `onChange` handler for the value input field.
    *   Modify the handler logic to check if the `event.target.value` is an empty string (`''`) *before* attempting to call `parseFloat`. If it's empty, handle it appropriately (e.g., set state to `null` or `0`) instead of parsing.

7.  **Refactor InitiativeForm Supabase Client Usage (`components/initiatives/InitiativeForm.tsx`):**
    *   **Issue:** The component imports and uses `supabase` directly from `../../utils/supabase` instead of using the shared client instance.
    *   **Task:** Import and use the `useSupabaseClient` hook from `@supabase/auth-helpers-react`.
    *   **Task:** Replace the direct `supabase.from(...).upsert(...)` call with one using the client obtained from the hook.
    *   **Task:** Remove the unused direct `supabase` import.

## Success Criteria
1.  **Capacity Chart Fixed:** The Capacity Chart on the `/capacity` page correctly displays "Mandatory Effort" and "Optional Effort" bars based on initiative data fetched from Supabase.
2.  **Metrics Page Loads:** The Metrics page (`/metrics`) loads without the "Cannot convert undefined or null to object" runtime error, and the type dropdown is populated.
3.  **Metrics Nav Link Added:** A "Metrics" link is present in the main navigation header and correctly navigates to `/metrics`.
4.  **GoTrueClient Warning Resolved:** The "Multiple GoTrueClient instances" warning no longer appears in the browser console.
5.  **Error Handling Consistent:** User-facing errors for async data operations in Initiatives, Metrics, and Capacity sections use the standardized `ErrorDisplay` component pattern.
6.  **MetricInput NaN Warning Resolved:** The "Received NaN for the 'value' attribute" warning no longer appears in the console when clearing the input field in `MetricInput`.
7.  **Confidence Constraint Added:** The `confidence_range` CHECK constraint exists on the `initiatives` table in the database schema.
8.  **No Regressions:** Core functionality for Initiatives (including saving/editing via the form), Metrics, and Capacity management remains operational.
9.  **Console Clean:** No *new* unexpected console warnings or errors are introduced during testing (Test 4.1 verification).
10. **InitiativeForm Refactored:** `InitiativeForm.tsx` uses `useSupabaseClient` hook for database operations.

## Notes on Scope & Approach
*   **Real-time Sync:** Only `InitiativeList` currently uses real-time updates. Adding real-time sync for `CapacityManager` is out of scope for v0.0.3i.
*   **Testing Approach:** Testing for v0.0.3i relies on the manual steps below. Implementing automated testing infrastructure remains a known item of technical debt.

## Manual Testing Steps

### 1. Verification of Fixes
- **Test 1.1**: Capacity Chart Data Display
  - **Action**: Navigate to the Capacity page after ensuring some initiatives exist for the logged-in user.
  - **Expected Result**: The "Capacity vs. Effort" chart displays orange and blue bars representing the sum of effort for mandatory and optional initiatives for each month, plotted against the green "Available Capacity" line.
  - **Status:** Passed (Data displays for full 12-month window; logic refinement deferred).
- **Test 1.2**: Metrics Page Load & Dropdown
  - **Action**: Navigate to the Metrics page (`/metrics`).
  - **Expected Result**: Page loads without runtime errors. The "Select Metric Type" dropdown contains options like 'Conversion Rate', 'Average Loan Size', 'Interest Rate'.
  - **Status:** Passed.
- **Test 1.3**: Metrics Navigation Link
  - **Action**: Check the main navigation header in the application.
  - **Expected Result**: A "Metrics" link is visible. Clicking it navigates to the `/metrics` page.
  - **Status:** Passed.
- **Test 1.4**: GoTrueClient Warning Check
  - **Action**: Navigate through different pages of the application (Login, Initiatives, Capacity, Metrics). Check the browser console.
  - **Expected Result**: The "Multiple GoTrueClient instances" warning is no longer present.
  - **Status:** Passed (After refactoring MetricsPage, InitiativeList, InitiativeForm).
- **Test 1.5**: MetricInput NaN Warning Check
  - **Action**: Navigate to the Metrics page. Select a metric type. Enter a value into the input field, then delete the value completely. Check the browser console.
  - **Expected Result**: No "Received NaN for the 'value' attribute" warning appears.
  - **Status:** Passed.
- **Test 1.6**: Database Constraint Check
  - **Action**: In the Supabase SQL Editor, attempt to insert or update an initiative with `confidence = -10` or `confidence = 110`.
  - **Expected Result**: The database operation fails due to the `confidence_range` constraint violation.
  - **Status:** Passed.
- **Test 1.7**: Error Handling Consistency (Visual Check)
  - **Action**: (If possible, simulate errors) Trigger save/load errors in Initiatives, Metrics, and Capacity sections (e.g., using network offline mode).
  - **Expected Result**: Error messages are displayed using the consistent red `ErrorDisplay` component across these sections.
  - **Status:** Skipped.
- **Test 1.8**: Initiative Form Save (Post-Refactor)
  - **Action**: Open the initiative form (create new or edit existing). Make a valid change and click Save.
  - **Expected Result**: The initiative is successfully saved or updated in the database (verify by checking the list or via Supabase table browser). No unexpected errors occur related to the Supabase client.
  - **Status:** Passed.

### 2. Polish & Regression Checks (Based on v0.0.3h Test 4)
- **Test 2.1**: Console Errors (Final Check)
  - **Action**: Use the Capacity, Initiatives, and Metrics pages, performing standard actions (add, edit, delete, change values).
  - **Expected Result**: No new or unexpected warnings or errors appear in the browser console.
  - **Status:** Passed.
- **Test 2.2**: Consistent UX (Final Check)
  - **Action**: Visually inspect loading indicators and error message styles across different sections.
  - **Expected Result**: Loading states and error handling feel visually consistent. 
  - **Status:** Passed. 