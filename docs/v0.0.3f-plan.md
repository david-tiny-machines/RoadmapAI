# v0.0.3f Implementation Plan: Forecasting Engine - Part 1

## Overview
Add forecasting capabilities to the metrics system, building on the chart visualization implemented in v0.0.3e.

## Components to Create

### 1. ForecastDisplay Component (`components/metrics/ForecastDisplay.tsx`)
```typescript
interface ForecastDisplayProps {
  metrics: HistoricalMetric[];
  metricType: DbMetricType;
  forecastMonths?: number; // How many months to project forward
  showConfidenceBands?: boolean;
}
```

Features:
- Extends existing line chart to show forecast
- Visual distinction between historical and projected data
- Confidence interval bands (optional)
- Tooltip shows forecast vs actual values
- Maintains existing formatting per metric type
- Automatically calculates date range:
  - Start: Earliest historical data point
  - End: Current date + forecast months

### 2. ForecastControls Component (`components/metrics/ForecastControls.tsx`)
```typescript
interface ForecastControlsProps {
  forecastMonths: number;
  onForecastMonthsChange: (months: number) => void;
  showConfidenceBands: boolean;
  onToggleConfidenceBands: () => void;
}
```

Features:
- Control forecast projection length
- Toggle confidence interval display
- Preset periods (3M, 6M, 1Y)
- Integration with existing chart controls

### 3. ForecastCalculator (`utils/forecastUtils.ts`)
```typescript
interface ForecastResult {
  projectedValues: Array<{ month: Date; value: number }>;
  confidenceInterval?: Array<{ month: Date; upper: number; lower: number }>;
}

// Core calculation functions
calculateForecast(metrics: HistoricalMetric[], months: number): ForecastResult;
calculateTrend(metrics: HistoricalMetric[]): { slope: number; intercept: number };
```

## Updates to Existing Components

### 1. MetricChart Updates
- Add forecast line series
- Update tooltip to handle forecast values
- Add visual styling for projections
- Handle confidence intervals in chart

### 2. metrics/index.tsx Updates
- Add forecast state management
- Handle forecast control interactions
- Update data fetching to support forecast range
- Date range selector only shown in table/chart views
- Forecast view uses all available historical data

## Manual Testing Steps

### 1. Forecast Display Tests
- **Test 1.1**: Basic Forecast Rendering
  - **Action**: 
    - Navigate to metrics page with historical data
    - Enable forecast display
    - Check each metric type
  - **Expected Result**:
    - Forecast line appears extending from historical data
    - Visual distinction between historical and forecast data
    - Y-axis scales appropriately to include forecast values
    - Proper formatting maintained for each metric type
    - Date range automatically extends into future based on forecast months

- **Test 1.2**: Forecast Controls
  - **Action**:
    - Adjust forecast period using controls
    - Toggle confidence bands
  - **Expected Result**:
    - Forecast line updates with period changes
    - Confidence bands appear/disappear when toggled
    - Controls reflect current state
    - Smooth transitions between states
    - Chart date range automatically adjusts with forecast period

### 2. Calculation Tests
- **Test 2.1**: Trend Calculation
  - **Action**:
    - View forecast with different historical ranges
    - Test with both increasing and decreasing trends
  - **Expected Result**:
    - Forecast follows historical trend
    - Reasonable projections based on recent data
    - No extreme or unrealistic values

- **Test 2.2**: Edge Cases
  - **Action**:
    - Test with minimal historical data
    - Test with flat or volatile historical data
  - **Expected Result**:
    - Graceful handling of limited data
    - Reasonable forecasts even with volatile data
    - Appropriate error messages or fallbacks

### 3. Integration Tests
- **Test 3.1**: View Mode Integration
  - **Action**:
    - Switch between table, chart, and forecast views
    - Change metric types with forecast enabled
  - **Expected Result**:
    - Date selector only appears in table/chart views
    - Forecast view shows all historical data
    - Forecast settings persist across view changes
    - Consistent display across metric types
    - No data loss during view switches

## Success Criteria
- Forecast calculations produce reasonable projections
- Visual integration with existing charts is seamless
- Controls are intuitive and responsive
- Edge cases are handled gracefully
- Performance remains smooth with calculations

## Known Limitations
- Initial version will not include:
  - Seasonal adjustments
  - Multiple forecast models
  - Export of forecast data
  - Manual forecast adjustments
  - Integration with initiatives (coming in next version)

## Next Steps
- Add initiative impact overlays
- Implement forecast vs actual tracking
- Add more sophisticated forecasting models
- Support seasonal pattern recognition 