# v0.0.4a Implementation Plan: Test Data & Scheduling Logic

## Overview
This version focuses on establishing the foundation for Phase 4 visualizations by:
1.  **Setting up Test Data:** Defining and populating the database with a consistent and diverse set of test initiatives and capacity data to facilitate development and testing.
2.  **Implementing Scheduling Logic:** Creating the core utility functions required to calculate the capacity-aware `roadmap_delivery_month` for each initiative based on its priority, effort, and the available monthly team capacity.

The outcome will be a populated test environment and the necessary calculation logic, ready for use in subsequent visualization tasks (`v0.0.4b`, `v0.0.4c`, `v0.0.4d`). This version does *not* include UI changes to display the schedule.

## Prerequisites
- Access to the application development environment (Replit)
- Supabase project access (SQL Editor)
- Chrome browser for testing/debugging
- Completion of v0.0.3j

## Test Environment
- Browser: Chrome latest version
- Screen size: Desktop viewport (e.g., 1920x1080)

## Database Updates

### 1. Test Data Seeding
*   **Action:** Create SQL scripts to populate the `initiatives` and `monthly_capacity` tables with a predefined set of test data. Execute these scripts via the Supabase SQL Editor.
*   **Data Requirements:** The test data should include:
    *   Multiple initiatives with varying `effort_estimate`, `priority_score`, `value_lever`, and `mandatory` status.
    *   Initiatives designed to test scheduling across multiple months.
    *   Scenarios where total monthly effort demands exceed capacity.
    *   Scenarios where some initiatives might not fit within the defined capacity window.
    *   `monthly_capacity` data covering a relevant period (e.g., next 12-24 months) with varying capacity levels.
*   **Scripting:**
    1.  **(Optional):** Create a script (`db/seeds/00_clear_data.sql`) with `DELETE FROM initiatives; DELETE FROM monthly_capacity;` statements (Use with caution!).
    2.  Create the main seeding script (`db/seeds/01_test_data.sql`) with `INSERT INTO` statements for `monthly_capacity` and `initiatives`. Ensure `user_id` values align with test user accounts if needed for RLS testing.
*   **Execution:** Run the scripts (clear script first if desired, then seeding script) manually via the Supabase SQL Editor.
*   **Repository:** Commit the SQL seed script(s) to the `db/seeds/` directory.

## Component & Configuration Updates

### 1. Scheduling Utility Implementation
*   **Action:** Create a new utility file (e.g., `utils/schedulingUtils.ts`) to house the capacity-aware scheduling logic.
*   **Function:** Define a primary function (e.g., `calculateRoadmapSchedule`) that takes the following inputs:
    *   `initiatives`: An array of `DbInitiativeType` objects.
    *   `capacity`: An array of `DbCapacityType` objects (or a map derived from it for easier lookup).
*   **Logic:**
    1.  Sort initiatives: Primarily by `mandatory` status (mandatory first), then secondarily by `priority_score` (descending).
    2.  Initialize: Create a data structure to track remaining capacity per month over the planning horizon defined by the `capacity` input.
    3.  Iterate & Allocate: Loop through the sorted initiatives. For each initiative:
        *   Determine the earliest possible allocation month, respecting the initiative's optional `start_month` (cannot allocate effort before this month). If `start_month` is after the capacity horizon, the initiative cannot be scheduled.
        *   Iterate through subsequent months *from the determined start month*, "allocating" the initiative's `effort_estimate` against the remaining monthly capacity.
        *   Keep track of how much effort is allocated in each month for the current initiative.
        *   The month in which the initiative's *cumulative* allocated effort reaches its `effort_estimate` is its `roadmap_delivery_month`. Handle initiatives spanning multiple months.
        *   Update the remaining capacity tracking structure after scheduling each initiative.
    4.  Deadline Check: After calculating the `roadmap_delivery_month`, compare it to the initiative's optional `end_month`. If the delivery month is later than the end month, mark the initiative with a `deadline_missed` flag. Also flag as missed if it couldn't be scheduled but had an `end_month`.
*   **Output:** The function should return an array of `ScheduledInitiative` objects (each being `DbInitiativeType` augmented with `roadmap_delivery_month: string | null` and `deadline_missed: boolean`). Initiatives that cannot be scheduled within the capacity horizon (due to lack of capacity or `start_month` constraints) will have `roadmap_delivery_month` set to `null`.
*   **Integration:** This utility function will be called by components/pages that require the schedule (e.g., potentially within `InitiativeList`, `pages/index.tsx`, `pages/capacity/index.tsx`, `pages/metrics/index.tsx` hooks or data fetching logic) in subsequent versions (`v0.0.4b`, `c`, `d`). For this version, ensure the function is exportable and callable.

## Success Criteria
1.  **Test Data Seeded:** The `initiatives` and `monthly_capacity` tables in the Supabase database are populated with the defined test data.
2.  **Seed Script Committed:** The SQL script(s) for creating the test data (`db/seeds/01_test_data.sql`) exist in the repository.
3.  **Scheduling Utility Exists:** The `utils/schedulingUtils.ts` file (or equivalent) exists and contains the `calculateRoadmapSchedule` function (or equivalent).
4.  **Scheduling Logic Correctness:** The `calculateRoadmapSchedule` function correctly calculates the `roadmap_delivery_month` based on capacity, effort, priority/mandatory status, and `start_month` constraints, and correctly sets the `deadline_missed` flag based on `end_month`, as verified through manual testing/debugging for various scenarios.
5.  **Augmented Data Accessible:** The structure returned by the scheduling function includes the calculated `roadmap_delivery_month` and `deadline_missed` flag for each initiative.

## Notes on Scope & Approach
*   This version focuses *solely* on data setup and the backend calculation logic.
*   No UI changes will be implemented to visualize the schedule or capacity based on this new logic.
*   The `roadmap_delivery_month` is a dynamically calculated value and will not be persisted back to the database in this phase. It will likely be managed within the application's state when needed.

## Manual Testing Steps

### 1. Verification of Test Data Setup
- **Test 1.1:** Database Population Check
  - **Action:** After running the seed script(s), use the Supabase Table Editor or SQL queries to inspect the `initiatives` and `monthly_capacity` tables.
  - **Expected Result:** The tables contain the exact data defined in the `01_test_data.sql` script. Counts match, and values look correct. If the clear script was run, no old data remains.
  - **Status:** Passed
- **Test 1.2:** Seed Script File Check
  - **Action:** Check the `db/seeds/` directory in the repository.
  - **Expected Result:** The `01_test_data.sql` (and optionally `00_clear_data.sql`) file exists and contains the correct SQL statements.
  - **Status:** Passed

### 2. Verification of Scheduling Logic
*Note: These tests might require temporary `console.log` statements within the utility function or using browser debugger tools where the function is called (even if the result isn't used in the UI yet). Tests verified using `/dev/test-schedule` page.* 
- **Test 2.1:** Basic Scheduling
  - **Action:** Prepare simple test data (e.g., 2-3 initiatives, ample capacity). Call `calculateRoadmapSchedule` with this data. Inspect the returned `roadmap_delivery_month` for each initiative.
  - **Expected Result:** Initiatives are scheduled in priority order, and the delivery month is calculated correctly based on simple effort allocation.
  - **Status:** Passed
- **Test 2.2:** Priority, Mandatory & Date Handling
  - **Action:** Use test data including mandatory initiatives, varying priorities, and initiatives with `start_month` and `end_month` constraints. Call the function.
  - **Expected Result:** Mandatory initiatives are scheduled before optional ones. Within those groups, initiatives are scheduled according to `priority_score`. Allocation respects `start_month`. `roadmap_delivery_month` reflects the correct completion month based on priority/capacity/start date. The `deadline_missed` flag is correctly set if `roadmap_delivery_month` > `end_month`.
  - **Status:** Passed
- **Test 2.3:** Capacity Constraint & Multi-Month Initiatives
  - **Action:** Use test data where monthly effort demand exceeds capacity, forcing initiatives to be pushed later. Include initiatives whose effort > single month capacity. Call the function.
  - **Expected Result:** Initiatives are correctly pushed to later months when capacity runs out. Initiatives spanning multiple months are assigned the correct final delivery month.
  - **Status:** Passed
- **Test 2.4:** Insufficient Overall Capacity / Start Date Constraints
  - **Action:** Use test data where the total effort exceeds capacity, or where an initiative's `start_month` is beyond the capacity horizon. Call the function.
  - **Expected Result:** Initiatives scheduled up to the capacity limit receive a `roadmap_delivery_month`. Subsequent initiatives or those starting too late receive `null`. The `deadline_missed` flag is set appropriately for unscheduled items with an `end_month`.
  - **Status:** Passed

### 3. Regression Checks
- **Test 3.1:** Core Functionality Sanity Check
  - **Action:** Briefly perform main actions: Log in, view/add/edit/delete an initiative, view/add metric data, view/update capacity. Ensure the application still loads and basic operations function.
  - **Expected Result:** All basic functions work without new console errors or unexpected behavior. The addition of the scheduling utility (even if not fully integrated) should not break existing functionality.
  - **Status:** Passed (User Verified) 