# v0.0.3e Implementation Plan: Metric Visualization

## Overview
Add chart visualization for historical metrics, building on the tabbed interface implemented in v0.0.3d.

## Components to Create

### 1. MetricChart Component (`components/metrics/MetricChart.tsx`)
```typescript
interface MetricChartProps {
  metrics: HistoricalMetric[];
  metricType: DbMetricType;
  dateRange?: { start: Date; end: Date };
  onDateRangeChange?: (range: { start: Date; end: Date }) => void;
}
```

Features:
- Line chart using Recharts
- Y-axis formatting based on metric type:
  - Conversion: Percentage (e.g., "5.25%")
  - Average Loan Size: Currency (e.g., "$250,000")
  - Interest Rate: Percentage (e.g., "3.75%")
- X-axis showing months
- Interactive tooltips showing exact values
- Loading state placeholder
- Empty state handling
- Responsive design

### 2. DateRangeSelector Component (`components/metrics/DateRangeSelector.tsx`)
```typescript
interface DateRangeSelectorProps {
  startDate: Date;
  endDate: Date;
  onChange: (range: { start: Date; end: Date }) => void;
  minDate?: Date;
  maxDate?: Date;
}
```

Features:
- Month/year selection dropdowns
- Preset ranges (3M, 6M, 1Y, All)
- Validation to ensure start < end
- Integration with existing date utilities

### 3. ChartControls Component (`components/metrics/ChartControls.tsx`)
```typescript
interface ChartControlsProps {
  onToggleDataPoints?: () => void;
  onToggleGrid?: () => void;
  showDataPoints: boolean;
  showGrid: boolean;
}
```

Features:
- Toggle data points visibility
- Toggle grid lines
- Future extension point for more controls

## Updates to Existing Components

### 1. MetricTable Updates
- Add toggle between table/chart view
- Ensure consistent date formatting with chart
- Add loading states to match chart

### 2. metrics/index.tsx Updates
- Add chart/table view state
- Handle date range selection
- Add chart-specific loading states

## Utility Functions (`utils/chartUtils.ts`)

```typescript
// New utilities needed:
- formatChartValue(value: number, type: DbMetricType): string
- getDefaultDateRange(): { start: Date; end: Date }
- aggregateMetricsByMonth(metrics: HistoricalMetric[]): AggregatedMetric[]
```

## Manual Testing Steps

### 1. Chart Display Tests
- **Test 1.1**: Basic Chart Rendering
  - **Action**: 
    - Navigate to metrics page
    - Switch to chart view
    - Select each metric type tab (Conversion, Average Loan Size, Interest Rate)
  - **Expected Result**:
    - Line chart appears for each metric type
    - Y-axis shows correct formatting:
      - Conversion: "0%" to "10%" with 1% intervals
      - Average Loan Size: "$0" to "$70,000" with $10,000 intervals
      - Interest Rate: "0%" to "6%" with 1% intervals
    - X-axis shows months
    - Chart line color matches metric type theme
    - Data points appear at each month's value
  - **Test Result**: Pass
    - Charts rendered correctly for all three metric types
    - Y-axis formatting verified:
      - Conversion: Shows 0.00% to 8.00% with 2% intervals
      - Average Loan Size: Shows $0.00 to $80,000.00 with $20,000 intervals
      - Interest Rate: Shows 0.00% to 8.00% with 2% intervals
    - X-axis correctly shows months from Apr 2024 to Apr 2025
    - Blue line color consistent across all charts
    - Data points visible and correctly positioned at each month's value
    - Grid lines and data points toggles working as expected

- **Test 1.2**: Chart Tooltips
  - **Action**:
    - Hover over data points on each chart type
  - **Expected Result**:
    - Tooltip appears showing:
      - Month in "MMM YYYY" format
      - Value with correct formatting:
        - Conversion: "5.25%"
        - Average Loan Size: "$65,000.00"
        - Interest Rate: "3.75%"
    - Tooltip remains visible while hovering
    - Tooltip disappears when mouse leaves data point
  - **Test Result**: Pass
    - Tooltips appear correctly on hover for all chart types
    - Verified formatting:
      - Conversion: Shows "Conversion : 3.55%" for Aug 2024
      - Average Loan Size: Shows "Average Loan Size : $35,000.00" for Dec 2024
      - Interest Rate: Shows "Interest Rate : 4.80%" for Aug 2024
    - Month format correct ("Aug 2024", "Dec 2024")
    - Tooltips are clearly visible with good contrast
    - Tooltips positioned correctly near data points

### 2. Date Range Tests
- **Test 2.1**: Preset Range Selection
  - **Action**:
    - Click each preset range button (3M, 6M, 1Y, All)
  - **Expected Result**:
    - Chart updates immediately to show selected range
    - For 6M preset:
      - Should show Nov 2024 to Apr 2025
      - 6 data points visible
      - Start and end dates in selector match range
    - Disabled state for ranges with insufficient data
  - **Test Result**: Pass
    - All preset ranges function correctly:
      - 3M shows last 3 months of data
      - 6M shows last 6 months of data
      - 1Y properly limits to last 12 months
      - All shows full dataset (Apr 2023 - Apr 2025)
    - Chart updates immediately when preset is clicked
    - Date selectors update to match selected range
    - X-axis adjusts scale appropriately for each range
    - Data points and trend line remain clear at all ranges

- **Test 2.2**: Custom Date Range
  - **Action**:
    - Select Jul 2023 as start date
    - Select Feb 2024 as end date (8-month custom period)
  - **Expected Result**:
    - Chart updates to show selected 8-month period
    - All data points between Jul 2023 and Feb 2024 visible
    - No gaps in data line
    - Date selectors show selected range
  - **Test Result**: Pass
    - Chart successfully updated to show Jul 2023 - Feb 2024
    - Y-axis automatically adjusted to new range (0.00% to 3.20%)
    - X-axis shows correct months with proper intervals
    - All data points visible and properly connected
    - Grid and data point toggles remain functional
    - Smooth transition when changing date range

### 3. Chart Controls
- **Test 3.1**: Toggle Data Points
  - **Action**:
    - Click "Show Data Points" toggle
  - **Expected Result**:
    - Data points disappear when toggled off
    - Line remains visible
    - Tooltips still work on hover over line
    - Toggle state persists when switching metric types
  - **Test Result**: Pass
    - Data points toggle on/off correctly
    - Line chart remains clear and readable without points
    - Tooltips continue to work when hovering over line
    - Toggle state correctly maintained when switching between metric types
    - Checkbox state visually indicates current setting

- **Test 3.2**: Toggle Grid Lines
  - **Action**:
    - Click "Show Grid" toggle
  - **Expected Result**:
    - Horizontal and vertical grid lines toggle visibility
    - Chart remains readable without grid
    - Axis lines remain visible
    - Toggle state persists when switching metric types
  - **Test Result**: Pass
    - Grid lines toggle on/off smoothly
    - Chart maintains readability with or without grid
    - Axis lines and labels remain clear
    - Toggle state preserved when switching between metrics
    - Checkbox state accurately reflects current setting

### 4. View Integration
- **Test 4.1**: View Switching
  - **Action**:
    - Switch between table and chart views multiple times
    - Change metric type tabs
    - Change date ranges
  - **Expected Result**:
    - View toggle button shows current state
    - Data consistency between views
    - Selected date range affects both views
    - Selected metric type tab persists across views
    - No data loss when switching views
  - **Test Result**: Pass
    - Table/Chart toggle buttons work correctly
    - Data remains consistent when switching views
    - Date range selections preserved between views
    - Active metric type tab maintained during view switches
    - All data points and formatting preserved
    - Smooth transition between views with no loading issues

## Success Criteria
- Charts render correctly for all metric types ✓
  - Conversion rates shown as percentages
  - Loan sizes shown in currency format
  - Interest rates shown as percentages
  - Appropriate Y-axis ranges and intervals
- Date range selection works smoothly ✓
  - Preset ranges (3M, 6M, 1Y, All) function correctly
  - Custom date selection works with any valid range
  - Chart updates immediately when range changes
- Consistent experience between table and chart views ✓
  - Data matches in both views
  - Settings persist when switching views
  - Active tab and date range maintained
- Smooth loading states and transitions ✓
  - No jarring UI changes
  - Chart updates are fluid
  - Controls respond immediately
- Chart controls function properly ✓
  - Data points can be toggled
  - Grid lines can be toggled
  - Settings persist across view changes

## Known Limitations
- Current Implementation:
  - Y-axis scale is fixed for each metric type
  - No ability to zoom into specific regions
  - Cannot compare multiple metrics on same chart
  - Limited to monthly data points
  - No data export functionality

- Future Enhancements to Consider:
  - Dynamic Y-axis scaling based on visible data range
  - Click-and-drag zoom functionality
  - Overlay multiple metrics for comparison
  - Weekly/quarterly data aggregation options
  - CSV/Excel export of chart data
  - Custom chart colors and themes
  - Trend line and forecast projections
  - Annotations for significant events 