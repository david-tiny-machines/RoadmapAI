# v0.0.5c Implementation Plan: Connect Frontend, Backend & Basic Conversational Flow

## Overview

This version focuses on enabling actual communication between the frontend chat UI created in `v0.0.5b` and the backend API endpoint set up in `v0.0.5a`. It will implement the basic turn-taking for the start of the conversation.

1.  **State Management:** Implement state management on the PRD Generator page (`pages/agents/prd-generator.tsx`) to handle the list of messages (`ChatMessage[]`) and the loading state (`isLoading`).
2.  **API Call Implementation:** Wire up the `handleSendMessage` function on the PRD Generator page to make a POST request to the `/api/agents/prd-generator` endpoint, sending the current message history.
3.  **Response Handling:** Process the response from the API, update the message list with both the user's message and the assistant's reply, and manage the loading state.
4.  **UI Updates:** Ensure the `ChatInterface` component correctly displays the updated message list and reflects the loading state.

## Prerequisites

-   Completion of `v0.0.5a` (Backend API endpoint exists and is runnable).
-   Completion of `v0.0.5b` (Frontend pages and `ChatInterface` component exist).
-   Access to the application development environment (Replit).
-   Access to the codebase.
-   Running application with user logged in (to handle authentication).

## Test Environment

-   Browser: Chrome latest version (or any modern browser).
-   User Accounts: Standard authenticated user access.
-   Browser Developer Tools (Network tab, Console tab).

## Database Updates

-   None required for this version.

## Component & Configuration Updates

1.  **PRD Agent Page (`pages/agents/prd-generator.tsx`):**
    *   **Action:** Modify the page component significantly.
    *   **Details:**
        *   Implement `useState` hooks for `messages: ChatMessage[]` and `isLoading: boolean`.
        *   Implement the `handleSendMessage` function:
            *   Set `isLoading` to `true`.
            *   Create the new user message object: `{ role: 'user', content: messageContent }`.
            *   Update the `messages` state immediately to include the user's message (optimistic update).
            *   Prepare the payload for the API call: `{ messages: [...currentMessages, newUserMessage] }`.
            *   Use `fetch` to make a POST request to `/api/agents/prd-generator` with the payload.
            *   Handle the response:
                *   On success (HTTP 200): Parse the JSON response, extract the `reply` content, create the assistant message object `{ role: 'assistant', content: reply }`, and update the `messages` state again to include the assistant's reply.
                *   On failure (non-200 response): Log the error, potentially display an error message to the user (e.g., by adding an error message to the chat or using a toast notification - basic console log for now is fine), create an assistant error message if desired.
            *   Set `isLoading` back to `false` in both success and error cases (e.g., in a `finally` block).
        *   Pass the actual `messages` state and the implemented `handleSendMessage` function as props to the `ChatInterface` component.
        *   Pass the `isLoading` state to the `ChatInterface` component.
        *   (Optional): Add an initial assistant message on component mount (e.g., "Hello! How can I help you start your PRD?") using a `useEffect` hook.

2.  **Chat UI Component (`components/agents/ChatInterface.tsx`):**
    *   **Action:** Minor adjustments to ensure props are used correctly.
    *   **Details:**
        *   Ensure the `onSendMessage` prop is correctly called by the `handleSend` internal function when the button is clicked or Enter is pressed.
        *   Ensure the `isLoading` prop correctly disables the input field and send button and potentially displays the "Thinking..." indicator.
        *   Verify message list rendering handles the updated `messages` state passed from the parent page.

## Success Criteria

1.  The PRD Generator page (`/agents/prd-generator`) loads with the chat interface.
2.  (Optional) An initial greeting message from the assistant is displayed.
3.  Typing a message (e.g., "Start PRD") and clicking "Send" adds the user's message to the chat display immediately.
4.  While waiting for the backend response, the input field and send button become disabled, and a loading indicator ("Thinking...") might appear.
5.  A network request (POST to `/api/agents/prd-generator`) is visible in the browser's developer tools (Network tab).
6.  After a short delay, the assistant's reply (e.g., asking for the executive summary) appears in the chat display.
7.  The input field and send button become enabled again after the response is received.
8.  The message history is maintained visually as the conversation progresses (for the initial turns).
9.  Errors during the API call (e.g., if the backend returns 500) are handled gracefully (e.g., logged to console, loading state reset) without crashing the frontend.

## Notes on Scope & Approach

*   Focuses on connecting the existing UI and backend for basic interaction.
*   Implements core state management for messages and loading on the page level.
*   Does *not* implement the full conversational logic for all MVP sections yet (`v0.0.5d`).
*   Error handling can be basic (console logs) for this version.
*   Does *not* include Markdown export (`v0.0.5e`).

## Manual Testing Steps

### 1. Initial Load & Greeting
-   **Test 1.1:** Load PRD Agent Page
    -   **Action:** Navigate to `/agents/prd-generator` while logged in.
    -   **Expected Result:** The page loads with the chat interface. (Optional: An initial assistant greeting message is displayed).
    -   **Status:** TBD

### 2. Sending First Message
-   **Test 2.1:** Send User Message
    -   **Action:** Type a message (e.g., "Let's create a PRD") into the input field and click "Send".
    -   **Expected Result:** The user's message appears immediately in the chat history (likely right-aligned). The input field and send button become disabled. A POST request to the API endpoint is initiated (visible in Network tab).
    -   **Status:** TBD
-   **Test 2.2:** Receive Assistant Reply
    -   **Action:** Wait for the backend response.
    -   **Expected Result:** An assistant message appears in the chat history (likely left-aligned) containing the expected reply (e.g., asking for the executive summary). The input field and send button become enabled again.
    -   **Status:** TBD

### 3. Follow-up Message (Basic Check)
-   **Test 3.1:** Send Second Message
    -   **Action:** Type a follow-up response (e.g., "The executive summary is...") and click "Send".
    -   **Expected Result:** The second user message appears, the UI enters loading state, and after a delay, a second assistant reply appears. The conversation history is preserved.
    -   **Status:** TBD

### 4. Error Handling (Conceptual/Manual Simulation if needed)
-   **Test 4.1:** Backend Error Simulation
    -   **Action:** (If possible/necessary) Temporarily modify the backend API route (`prd-generator.ts`) to force an error (e.g., `throw new Error('Test Error')` before returning JSON) and restart the server. Send a message from the frontend.
    -   **Expected Result:** The user message appears. The UI enters loading state. An error is logged in the browser console. The loading state eventually resets (input enabled). No frontend crash occurs. (Restore backend code afterwards).
    -   **Status:** TBD

### 5. Regression Checks
-   **Test 5.1:** Other Agent Pages/UI Elements
    -   **Action:** Navigate back to the `/agents` page.
    -   **Expected Result:** The agent list page functions as before.
    -   **Status:** TBD
-   **Test 5.2:** General Application Functionality
    -   **Action:** Briefly check navigation and core features on other pages (Initiatives, Capacity, etc.).
    -   **Expected Result:** No regressions introduced.
    -   **Status:** TBD 