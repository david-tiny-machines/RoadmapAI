# v0.0.3g Implementation Plan: Initiative Data Migration

## Overview
Move initiative data storage from local storage to Supabase, ensuring proper data relationships and type safety.

## Prerequisites
- Access to the application development environment
- Supabase credentials
- Chrome browser for testing
- Storage debug tool access (`/dev/storage-debug`)

## Test Environment
- Browser: Chrome latest version
- Screen size: Desktop viewport (1920x1080)
- Network: Test under normal conditions

## Type Definitions

### Database Types (`types/database.ts`)
```typescript
// ENUM types
export type DbMetricType = 'conversion' | 'average_loan_size' | 'interest_rate';
export type DbUserRole = 'admin' | 'user';
export type DbValueLever = 
  | 'conversion' 
  | 'average_loan_size' 
  | 'interest_rate' 
  | 'customer_acquisition' 
  | 'customer_retention' 
  | 'bau';

// Display mapping
export const VALUE_LEVER_DISPLAY: Record<DbValueLever, string> = {
  conversion: 'Conversion',
  average_loan_size: 'Average loan size',
  interest_rate: 'Interest rate',
  customer_acquisition: 'Customer acquisition',
  customer_retention: 'Customer retention',
  bau: 'Business as usual (BAU)'
};

// Utility functions
export function getValueLeverDisplay(lever: DbValueLever): string {
  return VALUE_LEVER_DISPLAY[lever];
}

export function getDbValueLever(display: string): DbValueLever {
  const entry = Object.entries(VALUE_LEVER_DISPLAY).find(([_, value]) => value === display);
  if (!entry) throw new Error(`Invalid value lever display: ${display}`);
  return entry[0] as DbValueLever;
}

// Database types
export interface DbInitiativeType {
  id: string;
  user_id: string;
  name: string;
  value_lever: DbValueLever;
  uplift: number;
  confidence: number;
  effort_estimate: number;
  start_month: string;
  end_month: string | null;
  is_mandatory: boolean;
  created_at: string;
  updated_at: string;
}
```

## Database Updates

### Migration Script
```sql
-- Create value_lever ENUM type
CREATE TYPE value_lever AS ENUM (
  'conversion',
  'average_loan_size',
  'interest_rate',
  'customer_acquisition',
  'customer_retention',
  'bau'
);

-- Update initiatives table
ALTER TABLE initiatives
  ALTER COLUMN value_lever TYPE value_lever USING value_lever::value_lever,
  ADD CONSTRAINT confidence_range CHECK (confidence >= 0 AND confidence <= 100),
  ADD CONSTRAINT effort_positive CHECK (effort_estimate > 0),
  ADD CONSTRAINT valid_dates CHECK (start_month <= COALESCE(end_month, start_month));
```

### RLS Policies
```sql
-- Only allow users to see their own initiatives
CREATE POLICY "Users can view own initiatives" ON initiatives
  FOR SELECT USING (auth.uid() = user_id);

-- Only allow users to modify their own initiatives
CREATE POLICY "Users can insert own initiatives" ON initiatives
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own initiatives" ON initiatives
  FOR UPDATE USING (auth.uid() = user_id);
```

## Success Criteria
1. All initiative data successfully stored in Supabase
2. Local storage cleared and no longer used ✅
3. Real-time updates working correctly
4. All type conversions functioning properly
5. Date handling working correctly
6. No console errors or warnings
7. All tests passing

## Known Limitations
- No bulk import/export yet
- No initiative versioning
- Basic validation only
- Single user-initiative relationship only

## Next Steps
- Implement v0.0.3h capacity migration
- Add more sophisticated validation
- Implement initiative versioning
- Add bulk operations

## Manual Testing Steps
The following test cases verify the successful migration from local storage to Supabase and ensure all functionality works as expected.

### 1. Basic Functionality Tests
- **Test 1.1**: New Installation
  - **Action**:
    - Clear all browser data
    - Load application fresh
  - **Expected Result**:
    - No errors
    - Empty initiatives list
    - Ready for new data entry
  - **Test Result**: ✅ PASS (2024-03-19)
    - Successfully cleared browser data using Chrome settings
    - Local storage verified empty (only auth tokens present)
    - Supabase data cleared using SQL command: DELETE FROM initiatives;
    - No errors encountered during the process
    - Environment ready for further testing

- **Test 1.2**: Data Entry
  - **Action**:
    - Create new initiatives
    - Check Supabase data
  - **Expected Result**:
    - Data saved directly to Supabase
    - Proper user associations
    - Correct date formats
    - Types converted correctly

### 2. Component Tests
- **Test 2.1**: InitiativeForm
  - **Action**:
    1. Create new initiative with the following data:
       - Name: "Improve Loan Application UX"
       - Value Lever: "Conversion"
       - Uplift: 15.5%
       - Confidence: 80%
       - Effort Estimate: 25 days
       - Start Month: April 2025
       - End Month: June 2025
       - Is Mandatory: No
    2. Edit initiative to:
       - Update Name: "Improve Loan Application UX - Phase 1"
       - Change Value Lever to: "Customer Retention"
       - Increase Uplift to: 20%
       - Adjust Effort to: 30 days
       - Set Is Mandatory: Yes
    3. Test date selection:
       - Try selecting end date before start date
       - Try selecting future dates
       - Try clearing end date
  - **Expected Result**:
    - Data saved in correct format in Supabase
    - Dates handled without timezone issues
    - Form validation prevents:
      - Empty name field
      - Negative uplift/confidence values
      - End date before start date
      - Zero effort estimate
    - Real-time updates reflect in UI immediately
    - Value Lever display names shown correctly
    - Mandatory flag updates initiative position
  - **Test Result**: ✅ PASS (YYYY-MM-DD) - Creation, editing, date handling (clearing, validation for end < start) confirmed working. Supabase data verified.

- **Test 2.2**: InitiativeList
  - **Action**:
    - Load initiatives list
    - Test sorting and filtering
    - Check real-time updates
  - **Expected Result**:
    - Correct data display
    - Proper type conversion
    - Real-time updates work
    - Performance is good
  - **Test Result**: ✅ PASS (YYYY-MM-DD) - List loading, mandatory sorting constraints, drag/drop reorder, reset order, and real-time updates (edit/delete) verified.

### 3. Error Handling Tests
- **Test 3.1**: Validation
  - **Action**:
    - Test all constraints
    - Try invalid data
  - **Expected Result**:
    - Proper error messages
    - Constraints enforced
    - Form state maintained
    - User feedback clear
  - **Test Result**: ✅ PASS (YYYY-MM-DD) - Confidence range (0-100), Effort > 0, Empty Name, and End Date < Start Date validation confirmed working. Negative uplift values now allowed and save correctly. Form state maintained on errors.
