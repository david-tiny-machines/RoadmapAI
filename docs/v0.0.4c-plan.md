# v0.0.4c Implementation Plan: Enhance Scheduling Logic & Capacity View

## Overview

This version focuses on enhancing the core scheduling logic and updating the dedicated Capacity page (`/capacity`) to provide a more accurate view of resource allocation.

1.  **Enhance Scheduling Logic:** Modify the `calculateRoadmapSchedule` utility (`utils/schedulingUtils.ts`) to determine not only the delivery month (`roadmap_delivery_month`) but also the month when work is first allocated (`roadmap_start_month`) for each initiative.
2.  **Update Capacity View:** Refactor the existing Capacity page (`pages/capacity/index.tsx`) and its associated chart component to consume the enhanced schedule data. It will now display the calculated **scheduled monthly effort load** against the user-defined available capacity, highlighting potential over-allocations.

The outcome will be an improved understanding of when initiative work is planned to occur and how that impacts monthly capacity constraints, visible on the `/capacity` page.

## Prerequisites

-   Completion of `v0.0.4b` (Roadmap page with delivery month markers implemented and tested).
-   Access to the application development environment (Replit).
-   Supabase project access (for data fetching).
-   Chrome browser for testing/debugging.

## Test Environment

-   Browser: Chrome latest version
-   Screen size: Desktop viewport (e.g., 1920x1080)

## Database Updates

No database schema changes are required for this version. The `roadmap_start_month` will be calculated dynamically by the scheduling utility.

## Component & Configuration Updates

### 1. Enhance `calculateRoadmapSchedule` Utility (`utils/schedulingUtils.ts`)

*   **Action:** Modify the scheduling algorithm to track and return the first month effort is allocated to an initiative.
*   **Logic Modification:**
    *   Within the existing loop that iterates through months and allocates effort:
        *   For each initiative, record the `currentMonth` the *first time* a non-zero amount of its `remainingEffort` is allocated.
        *   Store this first allocation month as `roadmap_start_month` for that initiative.
        *   Ensure this calculation correctly interacts with the existing optional `start_month` constraint (work cannot start before this date).
*   **Return Value:**
    *   Update the `ScheduledInitiative` interface (likely defined within `schedulingUtils.ts` or a shared types file) to include the new optional field: `roadmap_start_month: string | null`.
    *   Ensure the function returns the `ScheduledInitiative[]` array including this new field.
*   **(Optional) Refinement:** Consider if the function should also return a more detailed breakdown of effort allocated per initiative per month, which might simplify step 2, although calculating this on the Capacity page from start/end months is also feasible.

### 2. Update Capacity Page (`pages/capacity/index.tsx`)

*   **Action:** Refactor the page to use the enhanced schedule and display allocated effort.
*   **Data Fetching & Scheduling:**
    *   Ensure the page fetches both `initiatives` and `monthly_capacity` data for the user.
    *   Call the *enhanced* `calculateRoadmapSchedule` function (from `v0.0.4c` Task 1) to get the `ScheduledInitiative[]` array containing `roadmap_start_month` and `roadmap_delivery_month`.
*   **Effort Aggregation Logic:**
    *   Implement logic (likely within the page component or a helper function) to calculate the total scheduled effort load for each month within the displayed capacity range.
    *   This involves iterating through each month and summing the monthly effort portion of all initiatives considered *active* during that month.
    *   An initiative is active in a given month if the month falls within its `roadmap_start_month` and `roadmap_delivery_month` (inclusive).
    *   Assume effort is distributed evenly across the duration (delivery month - start month + 1). Calculate the approximate effort per month for each initiative (`effort_estimate / duration_in_months`).
    *   Handle initiatives that start/end mid-calculation (if implementing partial month allocation - simpler initial approach is full month allocation if active).
*   **Component Integration:**
    *   Pass the calculated monthly scheduled load data (e.g., `[{ month: '2025-04', scheduledDays: 55 }, ...]`) and the existing available capacity data to the capacity chart component.
*   **Chart Update:**
    *   Modify the existing capacity chart component (e.g., `components/capacity/CapacityChart.tsx`) to display the scheduled load alongside the available capacity.
    *   This likely involves adding a new data series (e.g., a second bar or a line) to the chart.
    *   Implement visual highlighting (e.g., changing bar color to red) for months where `scheduledDays` exceeds `availableDays`.
*   **State Management:** Update loading and error handling states as needed for the data fetching and calculation steps.

## Success Criteria

1.  **Scheduler Enhanced:** `calculateRoadmapSchedule` correctly calculates and returns `roadmap_start_month` for scheduled initiatives.
2.  **Type Updated:** The `ScheduledInitiative` type definition includes `roadmap_start_month: string | null`.
3.  **Capacity Page Data:** The `/capacity` page fetches initiative data and calls the enhanced `calculateRoadmapSchedule`.
4.  **Monthly Load Calculated:** The `/capacity` page correctly aggregates the scheduled effort per month based on initiative start/delivery dates and effort estimates.
5.  **Chart Displays Load:** The capacity chart visually represents the calculated scheduled load per month against the available capacity.
6.  **Over-Capacity Indicated:** Months where calculated scheduled load exceeds available capacity are visually highlighted on the chart.

## Notes on Scope & Approach

*   This version focuses on the `calculateRoadmapSchedule` utility and the `/capacity` page/chart.
*   No changes are planned for the `/roadmap` page visualization in *this* version (Gantt duration bars are targeted for `v0.0.4d`).
*   Assumes effort distribution is even across the initiative's scheduled duration for capacity planning purposes.
*   Error handling for data fetching and calculations should be included.

## Manual Testing Steps

### 1. Verification of Scheduler Enhancement
-   **Test 1.1:** `roadmap_start_month` Calculation
    -   **Action:** Use the `/dev/test-schedule` page (if still available) or add temporary console logs in `pages/capacity/index.tsx` to inspect the output of the enhanced `calculateRoadmapSchedule`.
    -   **Expected Result:** Verify that `roadmap_start_month` is present and appears correct for several initiatives based on manual calculation considering priority, effort, capacity, and `start_month` constraints. Initiatives that cannot be scheduled should have `null` for both start and delivery months.
    -   **Status:** Passed

### 2. Verification of Capacity View
-   **Test 2.1:** Chart Rendering
    -   **Action:** Log in and navigate to the `/capacity` page.
    -   **Expected Result:** The page loads, and the capacity chart renders without errors. Check the browser console.
    -   **Status:** Passed
-   **Test 2.2:** Scheduled Load Display
    -   **Action:** Observe the capacity chart.
    -   **Expected Result:** The chart now displays two series per month: Available Capacity and Scheduled Load (e.g., using grouped bars or stacked bars where applicable).
    -   **Status:** Passed
-   **Test 2.3:** Accuracy of Scheduled Load
    -   **Action:** Select a few months on the chart. Manually calculate the expected scheduled load for those months by summing the (effort / duration) for all initiatives active during that month (based on the schedule data from Test 1.1).
    -   **Expected Result:** The scheduled load displayed on the chart for the selected months matches the manual calculation (allowing for minor rounding differences if applicable).
    -   **Status:** Passed
-   **Test 2.4:** Over-Capacity Highlighting
    -   **Action:** Using the test data, identify a month where the total effort of scheduled initiatives is expected to exceed the available capacity.
    -   **Expected Result:** The chart visually highlights this month (e.g., the scheduled load bar is colored red or exceeds the available capacity marker clearly).
    -   **Status:** Passed

### 3. Regression Checks
-   **Test 3.1:** Core Functionality Sanity Check
    -   **Action:** Briefly perform main actions: Log in/out, view `/initiatives`, view `/roadmap`, view `/metrics`.
    -   **Expected Result:** All basic functions work without new console errors or unexpected behavior. Changes to the capacity calculation should not break other pages.
    -   **Status:** TBD 