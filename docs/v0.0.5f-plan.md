# v0.0.5f Implementation Plan: Initiative Selection on Start

## Overview

This version enhances the AI PRD Agent's starting interaction by making it aware of existing initiatives stored in the database. Instead of immediately asking for the executive summary, the agent will first present a list of existing initiatives and ask the user if they want to generate a PRD for one of them or start fresh for a new concept.

1.  **Fetch Initiatives:** Modify the backend API to query the Supabase `initiatives` table when a new conversation starts.
2.  **Update Initial Greeting:** Format the fetched initiative names into a numbered list within the first message sent to the user, including an option to create a PRD for a "New" initiative.
3.  **Handle Initial Response:** Update the backend logic to parse the user's first message to determine if they selected an existing initiative (by number) or chose "New". Store this context.
4.  **Adjust Conversation Flow:** Slightly adjust the subsequent prompts based on the user's choice (though the core MVP question flow remains largely the same).

## Prerequisites

-   Completion of `v0.0.5e` (Markdown Generation & Export).
-   Supabase database populated with some test initiatives.
-   Access to the application development environment (Replit).
-   Access to the codebase.
-   OpenAI API Key configured.
-   Supabase URL and Anon Key configured.

## Test Environment

-   Browser: Chrome latest version (or any modern browser).
-   User Accounts: Standard authenticated user access.
-   Supabase instance with test initiatives.
-   Browser Developer Tools (Console tab).

## Database Updates

-   None required. Assumes `initiatives` table exists and has some data as per `schema.sql` and potentially `db/seeds/01_test_data.sql`.

## Component & Configuration Updates

1.  **API Route (`pages/api/agents/prd-generator.ts`):**
    *   **Action:** Modify the handler, specifically the logic that runs when a session is initiated (i.e., when `sessionStore.get(sessionKey)` is initially empty or needs resetting).
    *   **Details:**
        *   **Import Supabase Client:** Ensure the Supabase client is properly initialized (likely using `@supabase/auth-helpers-nextjs`'s `createServerSupabaseClient`).
        *   **Fetch Initiatives:**
            *   Before creating the initial assistant message, perform an async query to fetch initiatives:
                ```typescript
                const { data: initiatives, error: dbError } = await supabase
                  .from('initiatives')
                  .select('id, name')
                  .order('created_at', { ascending: true }); // Or sort as desired

                if (dbError) {
                  console.error("Error fetching initiatives:", dbError);
                  // Handle error appropriately - perhaps send a fallback greeting
                }
                ```
            *   Handle the case where `initiatives` is null, empty, or there's an error.
        *   **Construct Initial Message:**
            *   Build the greeting string dynamically. If initiatives were fetched successfully:
                ```typescript
                let initialMessageContent = "Hello! I can help you generate a Product Requirements Document (PRD).\n\nWould you like to generate a PRD for an existing initiative or a new one?\n\n";
                if (initiatives && initiatives.length > 0) {
                  initiatives.forEach((initiative, index) => {
                    initialMessageContent += `${index + 1}. ${initiative.name}\n`;
                  });
                }
                initialMessageContent += "New - Start a PRD for a completely new initiative.\n\nPlease reply with the number of the initiative or the word \"New\".";
                ```
            *   If no initiatives or an error occurred, use a fallback greeting (e.g., the original one).
        *   **Store Initial Message:** Add the constructed greeting message to the session history as the first assistant message.
        *   **Modify Response Logic for First User Message:**
            *   Add logic to specifically handle the *first* message from the user after the new greeting.
            *   Check if the session state indicates this is the first user turn.
            *   Parse the user's input: Try to match it to a number corresponding to an initiative index or the literal string "New" (case-insensitive).
            *   **Store Context:** Add information to the session state indicating the user's choice (e.g., `selectedInitiativeId: uuid | null`, `isNewInitiative: boolean`).
            *   **Proceed:** After processing this first response, the *next* assistant message should be the standard first question of the PRD flow (e.g., asking for the executive summary). Acknowledge the user's choice briefly in this message (e.g., "Okay, let's start a PRD for 'Initiative Name X'. First, what's the executive summary?" or "Okay, let's start a new PRD. First, what's the executive summary?").
        *   **Subsequent Turns:** Ensure the regular conversation logic takes over after this initial selection step.

2.  **Frontend Page (`pages/agents/prd-generator.tsx`):**
    *   **Action:** Primarily ensure multi-line messages are displayed correctly.
    *   **Details:** Verify that the `ChatInterface` component correctly renders the multi-line greeting message containing the initiative list. No major state or logic changes should be needed on the frontend.

3.  **Chat UI Component (`components/agents/ChatInterface.tsx`):**
    *   **Action:** Ensure proper rendering of multi-line text.
    *   **Details:** Check CSS or component rendering logic to ensure `\n` characters in messages result in line breaks in the UI. Often, applying `white-space: pre-wrap;` CSS to the message container is sufficient.

## Success Criteria

1.  When starting a new PRD generation conversation, the first message from the agent includes a numbered list of existing initiatives fetched from the database and an option for "New".
2.  If no initiatives exist in the database, a fallback greeting is shown.
3.  The frontend UI correctly displays the multi-line greeting with numbered initiatives.
4.  Replying with a valid number corresponding to an initiative results in the agent acknowledging the selection and proceeding to the first question of the PRD flow (e.g., executive summary).
5.  Replying with "New" (case-insensitive) results in the agent acknowledging the choice and proceeding to the first question.
6.  Replying with invalid input (e.g., text that isn't "New", a number out of range) prompts the user again for a valid selection.
7.  The rest of the conversation flow (asking questions, generating Markdown via `/done`) remains functional after the initial selection.
8.  The backend correctly stores the context (selected initiative ID or "New") in the session state.

## Manual Testing Steps

### 1. Setup
-   Ensure at least 2-3 initiatives exist in the `initiatives` table in your Supabase database. Give them distinct names.

### 2. Initial Greeting and Selection
-   **Test 2.1:** Start New Conversation (With Initiatives)
    -   **Action:** Navigate to `/agents/prd-generator`.
    -   **Expected Result:** The first message from the agent should be the multi-line greeting, listing the initiatives from the database by number, followed by the "New" option and the prompt to reply.
    -   **Status:** PASS
-   **Test 2.2:** Select Existing Initiative by Number
    -   **Action:** Reply with a valid number corresponding to one of the listed initiatives (e.g., "1").
    -   **Expected Result:** The agent should respond with a message acknowledging the selected initiative by name (e.g., "Okay, let's start a PRD for 'Initiative Name A'. First, what's the executive summary?") and then ask the first PRD question.
    -   **Status:** PASS
-   **Test 2.3:** Select "New" Initiative
    -   **Action:** Reply with "New" (or "new", "NEW").
    -   **Expected Result:** The agent should respond with a message acknowledging the choice (e.g., "Okay, let's start a new PRD. First, what's the executive summary?") and then ask the first PRD question.
    -   **Status:** PASS
-   **Test 2.4:** Invalid Initial Selection
    -   **Action:** Reply with text that is not a valid number or "New" (e.g., "hello", "50" if only 3 initiatives exist).
    -   **Expected Result:** The agent should re-prompt the user to provide a valid selection, possibly repeating the list or instructions.
    -   **Status:** PASS

### 3. Conversation Flow Post-Selection
-   **Test 3.1:** Complete PRD Flow after Selecting Existing
    -   **Action:** After successfully selecting an existing initiative (Test 2.2), continue the conversation, answer all the agent's questions, and use `/done`.
    -   **Expected Result:** The agent should successfully guide through the PRD steps and generate the Markdown output as expected (per v0.0.5e). The generated PRD doesn't necessarily need to *use* the initiative name automatically in the content for this MVP step, but the flow should complete.
    -   **Status:** PASS
-   **Test 3.2:** Complete PRD Flow after Selecting "New"
    -   **Action:** After successfully selecting "New" (Test 2.3), continue the conversation, answer all questions, and use `/done`.
    -   **Expected Result:** The agent should successfully guide through the PRD steps and generate the Markdown output as expected.
    -   **Status:** PASS

### 4. Edge Case: No Initiatives
-   **Test 4.1:** Start Conversation (No Initiatives in DB)
    -   **Action:** Temporarily remove all initiatives from the `initiatives` table in Supabase (or test in an environment without any). Navigate to `/agents/prd-generator`.
    -   **Expected Result:** The agent should display a fallback initial greeting (likely the original one from before v0.0.5f) and proceed directly to asking the first PRD question.
    -   **Status:** PASS 