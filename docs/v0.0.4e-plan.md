# v0.0.4e Implementation Plan: Initiative Impact Visualization (Forecast View)

## Overview

This version focuses on integrating the planned roadmap schedule with metric forecasting. The goal is to visualize the expected impact of completed initiatives on the baseline metric forecasts displayed on the Metrics page (`/metrics`).

1.  **Data Fetching:** Enhance the Metrics page/Forecast component (`pages/metrics/index.tsx` or `components/metrics/ForecastDisplay.tsx`) to fetch necessary data: historical metrics, capacity, and initiative data (including `value_lever`, `uplift`, `confidence`).
2.  **Schedule Calculation:** Calculate the initiative schedule (determining `roadmap_delivery_month`) using the fetched initiatives and capacity via `calculateRoadmapSchedule`.
3.  **Baseline Forecast:** Calculate the baseline forecast using the historical metrics via `calculateForecast`.
4.  **Impact Calculation:** Implement new logic (likely in `utils/forecastUtils.ts` or a new utility) to calculate the cumulative impact of completed initiatives for each forecast month. This involves:
    *   Identifying initiatives completed by each month based on `roadmap_delivery_month`.
    *   Filtering initiatives relevant to the specific `metricType` being viewed (based on `value_lever`).
    *   Calculating the impact for each relevant, completed initiative (e.g., `(uplift / 100) * (confidence / 100)` for percentage metrics, needs verification for currency types like `average_loan_size`).
    *   Summing the impact cumulatively for each forecast month.
5.  **Adjusted Forecast:** Calculate the "Adjusted Forecast" by adding the cumulative impact to the baseline forecast for each month.
6.  **Visualization:** Update the `ForecastDisplay` component to plot the "Adjusted Forecast" as a new line series alongside the "Historical" and "Baseline Forecast" lines.

The outcome will be a forecast chart on the `/metrics` page that shows both the baseline projection and an adjusted projection reflecting the anticipated impact of the scheduled roadmap.

## Prerequisites

-   Completion of `v0.0.4d` (Gantt chart duration bars implemented and tested).
-   Access to the application development environment (Replit).
-   Supabase project access (for data fetching).
-   Understanding of the existing `calculateRoadmapSchedule` and `calculateForecast` utilities.

## Test Environment

-   Browser: Chrome latest version
-   Screen size: Desktop viewport (e.g., 1920x1080)

## Database Updates

No database schema changes are required for this version.

## Component & Configuration Updates

### 1. Data Fetching & Preparation (`pages/metrics/index.tsx` or `components/metrics/ForecastDisplay.tsx`)

*   **Action:** Ensure that initiative data (`initiatives` table) and capacity data (`monthly_capacity` table) are fetched alongside `historical_metrics` when the forecast view is active. This might involve adding new Supabase queries.
*   **Action:** Call `calculateRoadmapSchedule` with the fetched initiatives and capacity to get the `scheduledInitiatives` array (containing `roadmap_delivery_month` and other necessary fields like `id`, `value_lever`, `uplift`, `confidence`).
*   **Action:** Ensure the baseline forecast (`projectedValues` from `calculateForecast`) is available.

### 2. Impact Calculation Logic (`utils/forecastUtils.ts` or new utility)

*   **Action:** Create a new function, e.g., `calculateAdjustedForecast`.
*   **Input:** Baseline forecast points (`projectedValues`), scheduled initiatives (`ScheduledInitiative[]`), and the target `metricType`.
*   **Logic:**
    *   Iterate through each month in the `projectedValues`.
    *   For each forecast month, iterate through `scheduledInitiatives`.
    *   Identify initiatives completed by that month (`initiative.roadmap_delivery_month <= forecast_month`).
    *   Filter those completed initiatives to find ones relevant to the `metricType` (map `value_lever` to `metricType`).
        *   `conversion` lever -> `conversion` metric
        *   `average_loan_size` lever -> `average_loan_size` metric
        *   `interest_rate` lever -> `interest_rate` metric
        *   (Others like `customer_acquisition`, `customer_retention`, `bau` currently have no direct metric impact defined in the forecasting engine).
    *   Calculate the impact of each relevant initiative. **Crucially, determine the correct scaling:**
        *   If `uplift` represents percentage points (e.g., 5 means +5%), then for percentage metrics (conversion, interest rate), the impact is likely `(uplift / 100) * (confidence / 100)`.
        *   For currency metrics (`average_loan_size`), clarify if `uplift` is a percentage increase (e.g., 5 means +5% of baseline loan size) or an absolute currency amount. Assume percentage increase for now: `baseline_loan_size * (uplift / 100) * (confidence / 100)`. This requires having the baseline value available. This adds complexity. A simpler start might be to assume `uplift` for `average_loan_size` is an absolute amount. Let's assume **percentage point addition** for simplicity across all types for the first pass: impact = `(uplift / 100) * (confidence / 100)`. This needs confirmation/refinement.
    *   Sum the impact of all relevant, completed initiatives for the current forecast month.
    *   Calculate the adjusted value: `adjustedValue = baselineValue + cumulativeImpact`. Ensure `adjustedValue` doesn't go below zero.
*   **Output:** An array of adjusted forecast points, similar in structure to `projectedValues`.

### 3. Update `ForecastDisplay` Component (`components/metrics/ForecastDisplay.tsx`)

*   **Action:** Modify the `chartData` structure to include a new dataset for the "Adjusted Forecast".
*   **Data:** Populate this dataset using the results from the `calculateAdjustedForecast` function.
*   **Styling:** Choose a distinct color/style for the adjusted forecast line (e.g., solid line, different color).
*   **Tooltips/Legend:** Update tooltips and legend to include the adjusted forecast information.

## Success Criteria

1.  Metrics page loads without errors in forecast view.
2.  A new "Adjusted Forecast" line appears on the chart for relevant metric types.
3.  The adjusted forecast line correctly reflects the cumulative impact of initiatives scheduled for completion by each forecast month.
4.  The impact calculation correctly maps `value_lever` to `metricType`.
5.  The scaling and units of `uplift` and `confidence` are handled correctly (needs verification based on implementation choices).
6.  Tooltips and legend clearly distinguish between baseline and adjusted forecasts.
7.  Handles cases where no initiatives impact the selected metric.

## Notes on Scope & Approach

*   Focuses solely on adding the adjusted forecast line to the existing forecast chart.
*   Requires careful handling of how `uplift` impacts different metric types (percentage vs. currency). The initial approach will assume percentage point addition for simplicity, but this requires validation against requirements.
*   Does not include visualizing *when* individual initiative impacts start, only the cumulative effect based on completion month.
*   Assumes `calculateRoadmapSchedule` and `calculateForecast` (baseline) are working correctly.

## Manual Testing Steps

### 1. Verification of Adjusted Forecast Line
-   **Test 1.1:** Adjusted Line Rendering
    -   **Action:** Log in, navigate to `/metrics`, select a metric (e.g., Conversion Rate) that has impacting initiatives scheduled, and switch to the \'Forecast\' view.
    -   **Expected Result:** The chart displays three lines: Historical, Forecast (Baseline), and Adjusted Forecast. Check console for errors.
    -   **Status:** TBD
-   **Test 1.2:** Impact Calculation (Simple Case)
    -   **Action:** Ensure test data includes a single, high-confidence initiative impacting the selected metric, scheduled for completion early in the forecast period. Observe the Adjusted Forecast line.
    -   **Expected Result:** The Adjusted Forecast line should diverge from the Baseline Forecast starting the month *after* the initiative\'s `roadmap_delivery_month`, by an amount corresponding to the initiative\'s calculated impact.
    -   **Status:** TBD
-   **Test 1.3:** Cumulative Impact
    -   **Action:** Ensure test data includes multiple initiatives impacting the same metric, scheduled for completion in different months.
    -   **Expected Result:** The gap between Adjusted and Baseline forecasts should increase over time as more initiatives are completed.
    -   **Status:** TBD
-   **Test 1.4:** Value Lever Mapping
    -   **Action:** Select a metric (e.g., Average Loan Size). Ensure impacting initiatives have the correct `value_lever` (`average_loan_size`).
    -   **Expected Result:** Only initiatives with the matching lever affect the adjusted forecast for that metric. Initiatives with other levers (e.g., `conversion`) should not impact the loan size forecast.
    -   **Status:** TBD
-   **Test 1.5:** Tooltip and Legend
    -   **Action:** Hover over points on the forecast lines. Check the chart legend.
    -   **Expected Result:** Tooltips clearly display values for Baseline and Adjusted forecasts. The legend correctly identifies all three lines.
    -   **Status:** TBD
-   **Test 1.6:** No Impact Case
    -   **Action:** Select a metric for which no impacting initiatives are scheduled.
    -   **Expected Result:** The Adjusted Forecast line should perfectly overlap the Baseline Forecast line (or not be displayed if implemented that way).
    -   **Status:** TBD

### 2. Regression Checks
-   **Test 2.1:** Other Views/Pages
    -   **Action:** Check `/roadmap`, `/initiatives`, `/capacity`. Check \'Table\' and \'Chart\' views on `/metrics`. Log out/in.
    -   **Expected Result:** All other functionality remains intact without errors.
    -   **Status:** TBD