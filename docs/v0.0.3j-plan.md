# v0.0.3j Implementation Plan: Phase 3 Stability & Phase 4 Schema Prep

## Overview
This version focuses on two primary goals:
1.  **Verify Phase 3 Stability:** Conduct a focused review to ensure data consistency and address any lingering known issues from the Phase 3 migration (ref: `v0.0.3a` known issues list), particularly concerning initiative data handling (IDs, priority scores) and date/timestamp standardization.
2.  **Prepare Phase 4 Schema:** Define and implement the necessary Supabase database schema additions to support Phase 4 Scenario & Goal Planning features, specifically for storing and managing multiple roadmap scenarios.

The outcome should be a stable, consistent data foundation ready for Phase 4 feature development. This version does *not* include implementing Phase 4 UI features.

## Prerequisites
- Access to the application development environment (Replit)
- Supabase project access (SQL Editor, settings)
- Supabase CLI (for type generation)
- Chrome browser for testing
- Completion of v0.0.3i

## Test Environment
- Browser: Chrome latest version
- Screen size: Desktop viewport (e.g., 1920x1080)

## Database Updates

### 1. Phase 3 Data Consistency Review & Fixes (If Needed)
*   **Action:** Review the implementation against the `schema.sql` definition for the `initiatives` table and the known issues documented in `CHANGELOG.md [v0.0.3a]`.
*   **Check:**
    *   **Initiative IDs:** Confirm that initiative IDs are consistently handled as UUIDs throughout the frontend (e.g., in state management, API calls, component props) and align with the `schema.sql` PRIMARY KEY type. Address any discrepancies if `localStorage` string IDs persist.
    *   **`user_id` Association:** Verify that initiatives are correctly associated with `auth.uid()` on creation and that RLS policies are functioning as expected.
    *   **`priority_score`:** Investigate the current calculation and persistence mechanism. The `schema.sql` includes a `priority_score` column. Confirm if this is being correctly calculated (based on `uplift` * `confidence`) and stored in the database upon initiative creation/update, or if the client-side calculation noted in `v0.0.3a` still needs migration. Implement server-side calculation (e.g., via trigger or during upsert) if necessary.
    *   **Date/Timestamp Handling:** Review `InitiativeForm.tsx` and `CapacityManager.tsx` to ensure consistent use of date formats (e.g., `YYYY-MM-DD` for DATE type storage) and UTC methods to prevent timezone issues, aligning with fixes made for Metrics (`v0.0.3d`).
*   **Fixes:** Implement necessary code changes in components or add database triggers/functions based on the review findings to ensure data consistency.

### 2. New Schema for Phase 4 Scenarios
*   **Action:** Add new tables to support saving multiple roadmap scenarios.
*   **Migration Script:**
    ```sql
    -- Table to store overall scenario details
    CREATE TABLE IF NOT EXISTS scenarios (
      id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
      user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
      name TEXT NOT NULL,
      description TEXT,
      created_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,
      updated_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL
    );

    -- Index for user's scenarios
    CREATE INDEX scenarios_user_id_idx ON scenarios (user_id);

    -- Enable RLS for scenarios
    ALTER TABLE scenarios ENABLE ROW LEVEL SECURITY;

    -- Policies for scenarios: Users manage their own
    CREATE POLICY "Users can view their own scenarios" ON scenarios
      FOR SELECT USING (auth.uid() = user_id);
    CREATE POLICY "Users can insert their own scenarios" ON scenarios
      FOR INSERT WITH CHECK (auth.uid() = user_id);
    CREATE POLICY "Users can update their own scenarios" ON scenarios
      FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
    CREATE POLICY "Users can delete their own scenarios" ON scenarios
      FOR DELETE USING (auth.uid() = user_id);

    -- Trigger for scenarios updated_at
    CREATE TRIGGER update_scenarios_updated_at
      BEFORE UPDATE ON scenarios
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    -- Junction table linking initiatives to scenarios
    -- Stores which initiatives are included in a specific scenario
    CREATE TABLE IF NOT EXISTS scenario_initiatives (
      scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
      initiative_id UUID NOT NULL REFERENCES initiatives(id) ON DELETE CASCADE,
      -- Add scenario-specific overrides here if needed in future (e.g., different start/end?)
      created_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,
      PRIMARY KEY (scenario_id, initiative_id) -- Composite primary key
    );

    -- Index for faster lookups
    CREATE INDEX scenario_initiatives_scenario_id_idx ON scenario_initiatives (scenario_id);
    CREATE INDEX scenario_initiatives_initiative_id_idx ON scenario_initiatives (initiative_id);

    -- Enable RLS for scenario_initiatives
    ALTER TABLE scenario_initiatives ENABLE ROW LEVEL SECURITY;

    -- Policies for scenario_initiatives: Users can manage links for their own scenarios
    -- Assumes users implicitly own initiatives linked to their scenarios. Refine if initiative ownership differs.
    CREATE POLICY "Users can view initiative links for their own scenarios" ON scenario_initiatives
      FOR SELECT USING (EXISTS (SELECT 1 FROM scenarios WHERE scenarios.id = scenario_id AND scenarios.user_id = auth.uid()));
    CREATE POLICY "Users can insert initiative links for their own scenarios" ON scenario_initiatives
      FOR INSERT WITH CHECK (EXISTS (SELECT 1 FROM scenarios WHERE scenarios.id = scenario_id AND scenarios.user_id = auth.uid()));
    CREATE POLICY "Users can delete initiative links for their own scenarios" ON scenario_initiatives
      FOR DELETE USING (EXISTS (SELECT 1 FROM scenarios WHERE scenarios.id = scenario_id AND scenarios.user_id = auth.uid()));
    -- Note: Update policy might not be needed if only linking/unlinking via insert/delete.

    ```
*   **Migration Workflow Note:** Apply schema changes manually via the Supabase SQL Editor as per current team standard.

## Component & Configuration Updates

1.  **Fix Data Handling Logic (If Necessary):**
    *   Based on findings from "Phase 3 Data Consistency Review", update relevant components (`InitiativeList.tsx`, `InitiativeForm.tsx`, `CapacityManager.tsx`, `utils/prioritizationUtils.ts`, etc.) or database functions/triggers.
2.  **Update Supabase Types:**
    *   After applying database schema changes, regenerate the Supabase TypeScript types.
    *   **Action Required:** Run the following command in the terminal and commit the updated `types/supabase.ts` file:
        ```bash
        npx supabase gen types typescript --project-id <your-project-id> --schema public > types/supabase.ts
        ```
        *(Replace `<your-project-id>` with the actual project ID from Supabase settings)*

## Success Criteria
1.  **Initiative Data Consistent:** Initiative IDs (UUIDs), `user_id` linkage, and `priority_score` are handled consistently between the database schema and the application logic. Priority scores are stored and potentially calculated server-side.
2.  **Date Handling Consistent:** Date inputs and storage in `InitiativeForm` and `CapacityManager` use standardized formats and timezone handling (e.g., UTC for storage).
3.  **Scenario Schema Created:** The `scenarios` and `scenario_initiatives` tables exist in the Supabase database with the correct columns, types, constraints, indexes, RLS policies, and triggers.
4.  **Supabase Types Updated:** The `types/supabase.ts` file accurately reflects the updated database schema, including the new scenario tables.
5.  **No Regressions:** Core functionality (CRUD operations for Initiatives, Metrics, Capacity; Authentication) remains operational without new errors.

## Notes on Scope & Approach
*   This version *only* prepares the backend/data layer for scenarios. No UI for creating, managing, or comparing scenarios will be built.
*   Focus is on ensuring the foundational data model is robust before building more complex features upon it.

## Manual Testing Steps

### 1. Verification of Phase 3 Stability
- **Test 1.1:** Initiative CRUD & Priority
  - **Action:** Log in. Create a new initiative. Observe the network request or database record. Edit the initiative's uplift/confidence. Delete an initiative. View the initiative list.
  - **Expected Result:** Operations succeed. The `priority_score` in the database updates correctly based on uplift/confidence changes. Initiative IDs used in requests/state are UUIDs. No errors related to `user_id`.
  - **Status:** TBD
- **Test 1.2:** Initiative & Capacity Date Handling
  - **Action:** Create/edit an initiative, setting start/end dates. Input capacity data for various months in the Capacity Manager. Reload the page or view the data in the database.
  - **Expected Result:** Dates are displayed and stored correctly without unexpected shifts (e.g., off-by-one day/month). Stored dates should match the intended month (`YYYY-MM-DD` format, likely the first of the month).
  - **Status:** TBD

### 2. Verification of Phase 4 Schema Prep
- **Test 2.1:** Schema Existence Check
  - **Action:** Use the Supabase SQL Editor or table view.
  - **Expected Result:** The `scenarios` and `scenario_initiatives` tables exist with the columns, types, and constraints defined in the migration script. RLS is enabled, and policies are present. `update_updated_at_column` trigger is attached to `scenarios`.
  - **Status:** TBD
- **Test 2.2:** Scenario RLS Basic Check (SQL)
  - **Action:** In Supabase SQL Editor, simulate different users (if possible using JWT) or use `auth.uid()` directly. Try to INSERT, SELECT, UPDATE, DELETE rows in `scenarios` and `scenario_initiatives` that belong/don't belong to the current `auth.uid()`.
  - **Expected Result:** Operations should succeed only for rows where the `user_id` matches `auth.uid()` (for `scenarios`) or where the linked `scenario` belongs to `auth.uid()` (for `scenario_initiatives`), as per the policy definitions. Operations on others' data should be blocked.
  - **Status:** TBD
- **Test 2.3:** Type Generation Check
  - **Action:** Inspect the `types/supabase.ts` file after running the generation command.
  - **Expected Result:** The file contains type definitions for `scenarios` and `scenario_initiatives` within the `Database['public']['Tables']` structure.
  - **Status:** TBD

### 3. Regression Checks
- **Test 3.1:** Core Functionality Sanity Check
  - **Action:** Briefly perform main actions: Log in, view/add/edit/delete an initiative, view/add metric data, view/update capacity.
  - **Expected Result:** All basic functions work without new console errors or unexpected behavior.
  - **Status:** TBD 