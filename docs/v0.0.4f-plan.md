# v0.0.4f Implementation Plan: Global Data Visibility

## Overview

This version addresses a requirement change: all core data (initiatives, historical metrics, capacity) should be visible to *all* authenticated users, not just the user who created the data. This primarily involves modifying Supabase Row Level Security (RLS) policies.

1.  **Review Existing Policies:** Examine the current RLS policies for `initiatives`, `historical_metrics`, and `monthly_capacity` tables in the Supabase dashboard (or via SQL). Identify policies restricting `SELECT` based on `user_id`.
2.  **Modify SELECT Policies:** Update the RLS policies for the `SELECT` operation on these tables to allow access for any authenticated user. The typical condition is `auth.role() = 'authenticated'`.
3.  **Review/Modify Write Policies:** Decide and implement the RLS policies for `INSERT`, `UPDATE`, and `DELETE`.
    *   **Option A (Simplest):** Allow all authenticated users to perform write operations (`auth.role() = 'authenticated'`). Keep the `user_id` column for tracking purposes.
    *   **Option B (Creator Owns Writes):** Keep the existing write policies, restricting `UPDATE` and `DELETE` to the original creator (`auth.uid() = user_id`). Allow `INSERT` for any authenticated user (they become the owner).
    *   **Confirm:** Clarify the desired write permission behavior with the product owner/stakeholder if unclear. Assume Option A (global write access) for initial implementation unless specified otherwise.
4.  **Frontend Code Review (Optional but Recommended):** Briefly review data fetching logic in components related to initiatives, metrics, and capacity (e.g., `pages/initiatives/index.tsx`, `pages/metrics/index.tsx`, `pages/capacity/index.tsx`) to ensure no residual client-side filtering based on user ID is present. Remove any such filters if found.
5.  **Testing:** Thoroughly test data visibility and write permissions after policy changes. Verify that users can see data created by other users and that write operations function according to the implemented policies.

## Prerequisites

-   Access to the Supabase project dashboard or SQL editor with permissions to modify RLS policies.
-   Understanding of Supabase RLS concepts and syntax.
-   Access to the application development environment (Replit) for potential frontend checks and testing.

## Test Environment

-   Browser: Chrome latest version
-   Multiple User Accounts: Requires testing with at least two different authenticated user accounts in Supabase.

## Database Updates

-   **Action:** Modify RLS policies for `initiatives`, `historical_metrics`, and `monthly_capacity` tables.
    *   **Table: `initiatives`**
        *   Policy Name (Example): `Allow authenticated read access to all initiatives`
        *   Operation: `SELECT`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Policy Name (Example): `Allow authenticated write access to all initiatives` (Assuming Option A)
        *   Operation: `INSERT`, `UPDATE`, `DELETE`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Check Expression (for UPDATE/DELETE, if needed): `auth.role() = 'authenticated'::text`
    *   **Table: `historical_metrics`**
        *   Policy Name (Example): `Allow authenticated read access to all metrics`
        *   Operation: `SELECT`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Policy Name (Example): `Allow authenticated write access to all metrics` (Assuming Option A)
        *   Operation: `INSERT`, `UPDATE`, `DELETE`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Check Expression (for UPDATE/DELETE, if needed): `auth.role() = 'authenticated'::text`
    *   **Table: `monthly_capacity`**
        *   Policy Name (Example): `Allow authenticated read access to all capacity`
        *   Operation: `SELECT`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Policy Name (Example): `Allow authenticated write access to all capacity` (Assuming Option A)
        *   Operation: `INSERT`, `UPDATE`, `DELETE`
        *   Using Expression: `auth.role() = 'authenticated'::text`
        *   Check Expression (for UPDATE/DELETE, if needed): `auth.role() = 'authenticated'::text`
    *   **Note:** The exact policy names and expressions might vary based on existing setup. Remove or disable conflicting old policies (e.g., `Users can manage their own data`).

## Component & Configuration Updates

Minimal frontend changes anticipated, primarily focused on removing any client-side user filtering if it exists.

## Success Criteria

1.  Authenticated users can view initiatives created by *other* users on the `/initiatives` page.
2.  Authenticated users can view historical metrics entered by *other* users on the `/metrics` page.
3.  Authenticated users can view monthly capacity data set by *other* users on the `/capacity` page (Note: the current UI might only show the logged-in user's capacity input fields, but the underlying data fetching should retrieve all data if the chart aggregates it).
4.  Write operations (create, update, delete) function according to the chosen policy (e.g., any authenticated user can modify any record if Option A was chosen).
5.  Login/logout and basic application functionality remain unaffected.
6.  RLS policies correctly prevent unauthenticated users from accessing any data.

## Notes on Scope & Approach

*   Focuses exclusively on modifying RLS policies for global visibility.
*   Requires careful consideration of write permissions (Option A vs. Option B). Option A is assumed for simplicity unless otherwise directed.
*   The `user_id` column in tables should be retained to track authorship, even if write access becomes global.

## Manual Testing Steps

### 1. Setup
-   **Action:** Ensure at least two distinct user accounts exist in Supabase (`user_A`, `user_B`).
-   **Action:** Log in as `user_A`. Create at least one initiative, enter one historical metric point, and set capacity for one month.
-   **Action:** Log out. Log in as `user_B`. Create a *different* initiative, enter a *different* historical metric point, and set capacity for a *different* month.

### 2. Verification of Global Read Access
-   **Test 2.1:** Initiatives Visibility
    -   **Action:** Logged in as `user_B`, navigate to `/initiatives`.
    -   **Expected Result:** Both the initiative created by `user_A` and the initiative created by `user_B` are visible in the list. Check console for errors.
    -   **Status:** TBD
-   **Test 2.2:** Metrics Visibility
    -   **Action:** Logged in as `user_B`, navigate to `/metrics`. Select the relevant metric type and view the table or chart.
    -   **Expected Result:** Both the metric data point entered by `user_A` and the one entered by `user_B` are visible. Check console for errors.
    -   **Status:** TBD
-   **Test 2.3:** Capacity Visibility (Check underlying fetch/chart aggregation)
    -   **Action:** Logged in as `user_B`, navigate to `/capacity`. Observe the capacity chart. Use browser dev tools (Network tab) to inspect the API response for fetching capacity data.
    -   **Expected Result:** The API response should contain capacity data for *both* the month set by `user_A` and the month set by `user_B`. The chart should aggregate/display this combined data correctly (e.g., total capacity or load across all users, depending on its design). (Note: The input fields might still only show `user_B`'s entry for the specific month selected in the UI, this test focuses on the data fetched). Check console for errors.
    -   **Status:** TBD

### 3. Verification of Write Permissions (Assuming Option A: Global Write)
-   **Test 3.1:** Initiative Modification
    -   **Action:** Logged in as `user_B`, attempt to edit the initiative created by `user_A`. Save the changes.
    -   **Expected Result:** The edit is successful. Refresh the page; the changes persist.
    -   **Status:** TBD
-   **Test 3.2:** Initiative Deletion
    -   **Action:** Logged in as `user_B`, attempt to delete the initiative created by `user_A`.
    -   **Expected Result:** The deletion is successful. The initiative is removed from the list.
    -   **Status:** TBD
-   **Test 3.3:** Metric Modification/Deletion (If applicable via UI)
    -   **Action:** Logged in as `user_B`, attempt to modify/delete the metric entry from `user_A` (if the UI allows this - the current UI might focus on insertion).
    -   **Expected Result:** The operation succeeds if allowed by the UI.
    -   **Status:** TBD
-   **Test 3.4:** Capacity Modification
    -   **Action:** Logged in as `user_B`, navigate to `/capacity` and select the month `user_A` set capacity for. Attempt to change the capacity value set by `user_A`.
    -   **Expected Result:** The update is successful. Verify by re-fetching or checking the database/API response.
    -   **Status:** TBD

### 4. Regression Checks
-   **Test 4.1:** Authentication
    -   **Action:** Log out completely. Attempt to access `/initiatives`, `/metrics`, `/capacity`.
    -   **Expected Result:** User is redirected to the login page. No data is visible. Check console for errors. Attempt login; it should work as before.
    -   **Status:** TBD
-   **Test 4.2:** Other Functionality
    -   **Action:** Briefly check other pages like `/roadmap` and core interactions (e.g., creating *new* items as the logged-in user).
    -   **Expected Result:** All other existing functionality remains intact.
    -   **Status:** TBD 